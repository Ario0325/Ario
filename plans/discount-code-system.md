# ุทุฑุญ ูพุงุฏูโุณุงุฒ ุณุณุชู ฺฉุฏ ุชุฎูู ุญุฑููโุง

## ๐ ุฎูุงุตู
ูพุงุฏูโุณุงุฒ ุณุณุชู ฺฉุงูู ฺฉุฏ ุชุฎูู ุจุฑุง ูุฑูุดฺฏุงู ุขุฑู ุดุงูู:
- ุงุฌุงุฏ ู ูุฏุฑุช ฺฉุฏูุง ุชุฎูู ุงุฒ ูพูู ุงุฏูู (ูุงุฑุณ)
- ูพุดุชุจุงู ุงุฒ ุชุฎูู **ูุฎุตูุต ฺฉ ูุญุตูู** ุง **ฺฉู ุณุจุฏ ุฎุฑุฏ**
- ุงุนูุงู ู ุญุฐู ฺฉุฏ ุชุฎูู ุฏุฑ ุตูุญู ุณุจุฏ ุฎุฑุฏ
- ููุงุด ุขูุงุฑ ุงุณุชูุงุฏู ุฏุฑ ูพูู ุงุฏูู

---

## ๐๏ธ ูุนูุงุฑ ุณุณุชู

```mermaid
flowchart TD
    A[ุงุฏูู: ุงุฌุงุฏ ฺฉุฏ ุชุฎูู] --> B{ููุน ุชุฎูู}
    B -->|ูุญุตูู ุฎุงุต| C[ุงูุชุฎุงุจ ูุญุตูู + ููุฏุงุฑ ุชุฎูู]
    B -->|ฺฉู ุณุจุฏ| D[ููุฏุงุฑ ุชุฎูู ุจุฑุง ฺฉู ุณุจุฏ]
    
    E[ฺฉุงุฑุจุฑ: ูุงุฑุฏ ฺฉุฑุฏู ฺฉุฏ ุฏุฑ ุณุจุฏ ุฎุฑุฏ] --> F[ุงุนุชุจุงุฑุณูุฌ ฺฉุฏ]
    F -->|ูุนุชุจุฑ| G{ููุน scope}
    F -->|ูุงูุนุชุจุฑ| H[ููุงุด ุฎุทุง]
    
    G -->|ูุญุตูู ุฎุงุต| I[ุชุฎูู ููุท ุฑู ุขู ูุญุตูู]
    G -->|ฺฉู ุณุจุฏ| J[ุชุฎูู ุฑู ฺฉู ูุจูุบ]
    
    I --> K[ูุญุงุณุจู ูุจูุบ ููุง]
    J --> K
    K --> L[ููุงุด ุฏุฑ ุณุจุฏ ุฎุฑุฏ]
    L --> M[ุซุจุช ุณูุงุฑุด ุจุง ุชุฎูู]
    M --> N[ุงูุฒุงุด ุดูุงุฑูุฏู ุงุณุชูุงุฏู]
```

---

## ๐ ูุงูโูุง ุชุบุฑุงูุชู

### 1. `Cart_Module/models.py` โ ูุฏู DiscountCode

ูุฏู `DiscountCode` ุจุง ููุฏูุง ุฒุฑ ุงุถุงูู ูโุดูุฏ:

| ููุฏ | ููุน | ุชูุถุญ |
|------|-----|-------|
| `code` | CharField | ฺฉุฏ ุชุฎูู - ฺฉุชุงุ ุญุฑูู ุจุฒุฑฺฏ |
| `title` | CharField | ุนููุงู ุชุฎูู |
| `description` | TextField | ุชูุถุญุงุช |
| `discount_type` | CharField | ููุน: ุฏุฑุตุฏ ุง ูุจูุบ ุซุงุจุช |
| `scope` | CharField | **ุฌุฏุฏ**: ูุญุฏูุฏู: ฺฉู ุณุจุฏ ุง ูุญุตูู ุฎุงุต |
| `product` | ForeignKey to Product | **ุฌุฏุฏ**: ูุญุตูู ูุฑุชุจุท - ููุท ููุช scope=product |
| `value` | DecimalField | ููุฏุงุฑ ุชุฎูู |
| `max_discount_amount` | DecimalField | ุณูู ุชุฎูู - ุจุฑุง ุฏุฑุตุฏ |
| `min_order_amount` | DecimalField | ุญุฏุงูู ูุจูุบ ุณูุงุฑุด |
| `starts_at` | DateTimeField | ุชุงุฑุฎ ุดุฑูุน |
| `ends_at` | DateTimeField | ุชุงุฑุฎ ูพุงุงู |
| `usage_limit_total` | PositiveIntegerField | ุณูู ฺฉู ุงุณุชูุงุฏู |
| `usage_limit_per_user` | PositiveIntegerField | ุณูู ุงุณุชูุงุฏู ูุฑ ฺฉุงุฑุจุฑ |
| `used_count` | PositiveIntegerField | ุชุนุฏุงุฏ ุงุณุชูุงุฏู ุดุฏู |
| `is_active` | BooleanField | ูุนุงู/ุบุฑูุนุงู |

ููุฏูุง ุฌุฏุฏ ุฑู `Order`:
- `subtotal` โ ุฌูุน ูุจู ุงุฒ ุชุฎูู
- `discount_amount` โ ูุจูุบ ุชุฎูู
- `discount_code` โ FK ุจู DiscountCode

> **ูฺฉุชู**: ูุงฺฏุฑุดู `0003` ูุจูุงู ุงุฌุงุฏ ุดุฏู ูู ููุฏูุง `scope` ู `product` ุฑุง ูุฏุงุฑุฏ. ฺฉ ูุงฺฏุฑุดู ุฌุฏุฏ `0004` ุจุฑุง ุงุถุงูู ฺฉุฑุฏู ุงู ุฏู ููุฏ ุงุฌุงุฏ ุฎูุงูุฏ ุดุฏ.

### 2. `Cart_Module/admin.py` โ ูพูู ุงุฏูู ูุงุฑุณ

```
DiscountCodeAdmin:
โโโ fieldsets (ูุงุฑุณ):
โ   โโโ ุงุทูุงุนุงุช ูพุงู: code, title, description
โ   โโโ ููุน ู ููุฏุงุฑ ุชุฎูู: discount_type, scope, product, value, max_discount_amount
โ   โโโ ุดุฑุงุท ุงุณุชูุงุฏู: min_order_amount, starts_at, ends_at
โ   โโโ ูุญุฏูุฏุช ุงุณุชูุงุฏู: usage_limit_total, usage_limit_per_user
โ   โโโ ูุถุนุช ู ุขูุงุฑ: is_active, used_count, created_at, updated_at
โโโ list_display: code, title, discount_type, scope, value, used_count, is_active, ends_at
โโโ list_filter: is_active, discount_type, scope
โโโ search_fields: code, title
โโโ readonly_fields: used_count, created_at, updated_at
โโโ help_texts: ุชูุถุญ ูุงุฑุณ ุจุฑุง ูุฑ ููุฏ
```

ูฺฺฏโูุง ุฎุงุต:
- ููุงุด ุชุนุฏุงุฏ ุงุณุชูุงุฏูโฺฉููุฏฺฏุงู
- ููุชุฑ ุจุฑ ุงุณุงุณ ููุน ู ูุถุนุช
- ููุฏ `product` ููุท ููุช `scope=product` ููุงุด ุฏุงุฏู ุดูุฏ (ุจุง JavaScript ุฏุฑ admin)
- help_text ูุงุฑุณ ุจุฑุง ูุฑ ููุฏ

### 3. `Cart_Module/services.py` โ ุณุฑูุณโูุง ุชุฎูู

ุงุถุงูู ุดุฏู:
- `DISCOUNT_SESSION_KEY = 'discount_code'`
- ุชูุงุจุน ฺฉูฺฉ ุจุฑุง ุงุนุชุจุงุฑุณูุฌ ู ูุญุงุณุจู ุชุฎูู

### 4. `Cart_Module/views.py` โ ูููุง ุฌุฏุฏ

| ูู | URL | ูุชุฏ | ุชูุถุญ |
|-----|-----|-----|-------|
| `discount_apply` | `/cart/discount/apply/` | POST | ุงุนูุงู ฺฉุฏ ุชุฎูู |
| `discount_remove` | `/cart/discount/remove/` | POST | ุญุฐู ฺฉุฏ ุชุฎูู |

ุชุบุฑุงุช ุฏุฑ ูููุง ููุฌูุฏ:
- `cart_detail`: ูุญุงุณุจู ุชุฎูู ู ุงุฑุณุงู ุจู template
- `checkout_view`: ุงุนุชุจุงุฑุณูุฌ ูุฌุฏุฏุ ุฐุฎุฑู ุฏุฑ Orderุ ุงูุฒุงุด used_count

### 5. `Cart_Module/urls.py` โ ูุณุฑูุง ุฌุฏุฏ

```python
path('discount/apply/', views.discount_apply, name='discount_apply'),
path('discount/remove/', views.discount_remove, name='discount_remove'),
```

### 6. `Cart_Module/templates/cart/cart.html` โ ูุฑู ุชุฎูู

ุชุบุฑุงุช:
- ูุนุงู ฺฉุฑุฏู ูุฑู ฺฉุฏ ุชุฎูู (ุญุฐู disabled)
- ุงุชุตุงู action ุจู `cart:discount_apply`
- ููุงุด ฺฉุฏ ูุนุงู ุจุง ุฏฺฉูู ุญุฐู
- ููุงุด ูุจูุบ ุชุฎูู ุฏุฑ ุฎูุงุตู ุณุจุฏ
- ููุงุด ูุงู ูุญุตูู ุชุฎููโุฎูุฑุฏู ุงฺฏุฑ scope=product

### 7. `Cart_Module/templates/cart/payment.html` โ ููุงุด ุชุฎูู

- ููุงุด ุฑุฏู ุชุฎูู ุฏุฑ ุฎูุงุตู ูพุฑุฏุงุฎุช
- ููุงุด ฺฉุฏ ุชุฎูู ุงุณุชูุงุฏู ุดุฏู

### 8. `Cart_Module/templates/cart/invoice.html` โ ููุงุด ุชุฎูู

- ููุงุด ุฑุฏู ุชุฎูู ุฏุฑ ูุงฺฉุชูุฑ
- ููุงุด ฺฉุฏ ุชุฎูู

---

## ๐ ููู ุงุนูุงู ฺฉุฏ ุชุฎูู

```mermaid
sequenceDiagram
    participant U as ฺฉุงุฑุจุฑ
    participant V as View
    participant M as Model
    participant S as Session

    U->>V: POST /cart/discount/apply/ ุจุง code
    V->>M: ุฌุณุชุฌู DiscountCode ุจุง code
    
    alt ฺฉุฏ ูพุฏุง ูุดุฏ
        V->>U: ูพุงู ุฎุทุง - ฺฉุฏ ูุงูุนุชุจุฑ
    else ฺฉุฏ ูพุฏุง ุดุฏ
        V->>M: ุจุฑุฑุณ is_active
        V->>M: ุจุฑุฑุณ ุชุงุฑุฎ starts_at ู ends_at
        V->>M: ุจุฑุฑุณ usage_limit_total
        V->>M: ุจุฑุฑุณ usage_limit_per_user
        V->>M: ุจุฑุฑุณ min_order_amount
        
        alt scope = product
            V->>M: ุจุฑุฑุณ ูุฌูุฏ ูุญุตูู ุฏุฑ ุณุจุฏ
        end
        
        alt ููู ุดุฑุงุท OK
            V->>S: ุฐุฎุฑู ฺฉุฏ ุฏุฑ session
            V->>U: ูพุงู ููููุช + redirect ุจู ุณุจุฏ
        else ุดุฑุท ูุงูููู
            V->>U: ูพุงู ุฎุทุง ููุงุณุจ
        end
    end
```

---

## ๐ ููู ุญุฐู ฺฉุฏ ุชุฎูู

```mermaid
sequenceDiagram
    participant U as ฺฉุงุฑุจุฑ
    participant V as View
    participant S as Session

    U->>V: POST /cart/discount/remove/
    V->>S: ุญุฐู ฺฉุฏ ุงุฒ session
    V->>U: ูพุงู + redirect ุจู ุณุจุฏ
```

---

## ๐ ููู checkout ุจุง ุชุฎูู

```mermaid
sequenceDiagram
    participant V as checkout_view
    participant S as Session
    participant M as DiscountCode
    participant O as Order

    V->>S: ุฎูุงูุฏู discount_code ุงุฒ session
    
    alt ฺฉุฏ ููุฌูุฏ ุฏุฑ session
        V->>M: ุงุนุชุจุงุฑุณูุฌ ูุฌุฏุฏ ฺฉุฏ
        alt ฺฉุฏ ูููุฒ ูุนุชุจุฑ
            V->>M: ูุญุงุณุจู ูุจูุบ ุชุฎูู
            V->>O: ุฐุฎุฑู subtotal ู discount_amount ู discount_code
            V->>M: ุงูุฒุงุด used_count
        else ฺฉุฏ ูุงูุนุชุจุฑ ุดุฏู
            V->>O: ุฐุฎุฑู ุจุฏูู ุชุฎูู
            V->>S: ุญุฐู ฺฉุฏ ุงุฒ session
        end
    else ุจุฏูู ฺฉุฏ
        V->>O: ุฐุฎุฑู ุนุงุฏ
    end
    
    V->>S: ูพุงฺฉ ฺฉุฑุฏู ุณุจุฏ ู ฺฉุฏ ุชุฎูู
```

---

## ๐จ ุทุฑุงุญ UI ุณุจุฏ ุฎุฑุฏ

### ุญุงูุช ุจุฏูู ฺฉุฏ ุชุฎูู:
- ูุฑู ูุฑูุฏ ฺฉุฏ ุชุฎูู ูุนุงู ุจุง input ู ุฏฺฉูู ุงุนูุงู

### ุญุงูุช ุจุง ฺฉุฏ ุชุฎูู ูุนุงู:
- ููุงุด ฺฉุฏ ูุนุงู ุจุง badge ุณุจุฒ
- ุฏฺฉูู ุญุฐู ฺฉุฏ ุชุฎูู ุจุง ุขฺฉู โ
- ุฏุฑ ุฎูุงุตู ุณุจุฏ: ุฑุฏู ุชุฎูู ุจุง ูุจูุบ ููู
- ูุจูุบ ููุง ุจุง ุงุญุชุณุงุจ ุชุฎูู

---

## โ ฺฺฉโูุณุช ูพุงุฏูโุณุงุฒ

1. ุงุถุงูู ฺฉุฑุฏู ูุฏู `DiscountCode` ุจู `Cart_Module/models.py` ุจุง ููุฏูุง scope ู product
2. ุงุถุงูู ฺฉุฑุฏู ููุฏูุง ุชุฎูู ุจู ูุฏู `Order`
3. ุงุฌุงุฏ ูุงฺฏุฑุดู ุฌุฏุฏ ุจุฑุง ููุฏูุง scope ู product
4. ูพุงุฏูโุณุงุฒ `DiscountCodeAdmin` ูุงุฑุณ ุจุง fieldsets ู help_texts
5. ุงุถุงูู ฺฉุฑุฏู `DISCOUNT_SESSION_KEY` ู ุชูุงุจุน ฺฉูฺฉ ุจู services
6. ูพุงุฏูโุณุงุฒ ูููุง `discount_apply` ู `discount_remove`
7. ุจูโุฑูุฒุฑุณุงู `cart_detail` ุจุฑุง ูุญุงุณุจู ู ููุงุด ุชุฎูู
8. ุจูโุฑูุฒุฑุณุงู `checkout_view` ุจุฑุง ุงุนุชุจุงุฑุณูุฌ ู ุฐุฎุฑู ุชุฎูู
9. ุงุถุงูู ฺฉุฑุฏู URL patterns ุฌุฏุฏ
10. ุจูโุฑูุฒุฑุณุงู template ุณุจุฏ ุฎุฑุฏ
11. ุจูโุฑูุฒุฑุณุงู template ูพุฑุฏุงุฎุช
12. ุจูโุฑูุฒุฑุณุงู template ูุงฺฉุชูุฑ
13. ุงุฌุฑุง ุชุณุชโูุง
